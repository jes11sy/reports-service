generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Модели для отчетов
model Order {
  id             Int       @id @default(autoincrement())
  rk             String
  city           String
  avitoName      String?   @map("avito_name")
  phone          String
  typeOrder      String    @map("type_order")
  clientName     String    @map("client_name")
  address        String
  dateMeeting    DateTime  @map("date_meeting")
  typeEquipment  String    @map("type_equipment")
  problem        String
  callRecord     String?   @map("call_record")
  statusOrder    String    @map("status_order")
  masterId       Int?      @map("master_id")
  result         Decimal?  @db.Decimal(10, 2)
  expenditure    Decimal?  @db.Decimal(10, 2)
  clean          Decimal?  @db.Decimal(10, 2)
  masterChange   Decimal?  @map("master_change") @db.Decimal(10, 2)
  bsoDoc         String[]  @default([]) @map("bso_doc")
  expenditureDoc String[]  @default([]) @map("expenditure_doc")
  operatorNameId Int       @map("operator_name_id")
  createDate     DateTime  @map("create_date")
  closingData    DateTime? @map("closing_data")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  avitoChatId    String?   @map("avito_chatid")
  callId         String?   @map("call_id")
  prepayment     Decimal?  @db.Decimal(10, 2)
  dateClosmod    DateTime? @map("date_closmod")
  comment        String?
  cashSubmissionStatus String?      @default("Готово") @map("cash_submission_status")
  cashSubmissionDate   DateTime?    @map("cash_submission_date")
  cashSubmissionAmount Decimal?     @map("cash_submission_amount") @db.Decimal(10, 2)
  cashReceiptDoc       String?      @map("cash_receipt_doc")
  cashApprovedBy       Int?         @map("cash_approved_by")
  cashApprovedDate     DateTime?    @map("cash_approved_date")
  
  partner              Boolean?     @default(false)
  partnerPercent       Decimal?     @map("partner_percent") @db.Decimal(5, 2)
  
  master               Master?     @relation(fields: [masterId], references: [id])
  
  @@index([statusOrder, city])
  @@index([closingData])
  @@index([masterId, city, closingData])
  @@index([phone])
  @@index([createDate, city])
  @@index([operatorNameId])
  @@index([createDate])
  @@index([avitoName])
  // Оптимизированные индексы для производительности (базовые)
  @@index([operatorNameId, createDate])
  @@index([city, createDate, statusOrder])
  @@index([rk, createDate])
  @@index([statusOrder, closingData])
  // ✅ Новые индексы для аналитики (декабрь 2025)
  @@index([city, statusOrder, partner])
  @@index([statusOrder, clean])
  @@index([masterId, city])
  @@index([rk, avitoName, statusOrder])
  @@index([city, statusOrder, closingData])
  @@map("orders")
}

model Master {
  id           Int      @id @default(autoincrement())
  cities       String[]
  name         String
  login        String?  @unique
  password     String?
  passportDoc  String?  @map("passport_doc")
  contractDoc  String?  @map("contract_doc")
  statusWork   String   @map("status_work")
  dateCreate   DateTime @default(now()) @map("date_create")
  note         String?
  tgId         String?  @map("tg_id")
  chatId       String?  @map("chat_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  orders       Order[]

  @@map("master")
}

model Director {
  id           Int      @id @default(autoincrement())
  cities       String[]
  name         String
  login        String   @unique
  password     String
  contractDoc  String?  @map("contract_doc")
  passportDoc  String?  @map("passport_doc")
  dateCreate   DateTime @default(now()) @map("date_create")
  note         String?
  tgId         String?  @map("tg_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  @@map("director")
}

model CallcentreOperator {
  id             Int       @id @default(autoincrement())
  name           String
  login          String    @unique
  password       String
  city           String
  status         String
  statusWork     String    @map("status_work")
  passport       String?
  contract       String?
  dateCreate     DateTime  @map("date_create")
  note           String?
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  sipAddress     String?   @map("sip_address")
  
  @@map("callcentre_operator")
}

model CallcentreAdmin {
  id        Int      @id @default(autoincrement())
  login     String   @unique
  password  String
  note      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("callcentre_admin")
}

model Cash {
  id             Int      @id @default(autoincrement())
  name           String
  amount         Decimal  @db.Decimal(10, 2)
  city           String?  @default("Москва")
  note           String?
  receiptDoc     String?  @map("receipt_doc")
  paymentPurpose String?  @map("payment_purpose")
  dateCreate     DateTime @default(now()) @map("date_create")
  nameCreate     String   @map("name_create")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([name, city])
  @@index([dateCreate])
  @@index([city])
  @@index([nameCreate])
  @@map("cash")
}

model Call {
  id                   Int       @id @default(autoincrement())
  rk                   String
  city                 String
  avitoName            String?   @map("avito_name")
  phoneClient          String    @map("phone_client")
  phoneAts             String    @map("phone_ats")
  dateCreate           DateTime  @map("date_create")
  operatorId           Int       @map("operator_id")
  status               String
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  recordingEmailSent   Boolean   @default(false) @map("recording_email_sent")
  recordingPath        String?   @map("recording_path")
  recordingProcessedAt DateTime? @map("recording_processed_at")
  // Поля от Mango Office
  callId               String?   @unique @map("call_id")
  duration             Int?
  recordUrl            String?   @map("record_url")
  
  @@index([city])
  @@index([dateCreate])
  @@index([operatorId])
  @@index([phoneClient])
  @@index([phoneAts])
  @@index([avitoName])
  @@index([callId])
  // Новые составные индексы для аналитики
  @@index([operatorId, dateCreate, status])
  @@index([city, dateCreate])
  @@index([dateCreate, status])
  @@map("calls")
}

// Логи ошибок (shared with auth-service)
model ErrorLog {
  id             Int      @id @default(autoincrement())
  timestamp      DateTime @default(now())
  service        String   @db.VarChar(100)
  errorType      String   @db.VarChar(255)
  errorMessage   String   @db.Text
  stackTrace     String?  @db.Text
  userId         Int?
  userRole       String?  @db.VarChar(50)
  requestUrl     String?  @db.VarChar(500)
  requestMethod  String?  @db.VarChar(10)
  ip             String?  @db.VarChar(45)
  userAgent      String?  @db.Text
  metadata       Json?    @db.JsonB

  @@index([timestamp(sort: Desc)])
  @@index([service, timestamp(sort: Desc)])
  @@index([errorType])
  @@index([userId])
  @@map("error_logs")
}





