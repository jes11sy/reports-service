# Reports Service - Deployment Guide

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ

–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –±–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫.

## üìã –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤ (–≤—Å–µ–≥–æ, –ø—Ä–∏–Ω—è—Ç–æ, –ø—Ä–æ–ø—É—â–µ–Ω–æ, % –æ—Ç–≤–µ—Ç–æ–≤)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ (–≤—Å–µ–≥–æ, –∑–∞–∫—Ä—ã—Ç–æ, –∫–æ–Ω–≤–µ—Ä—Å–∏—è)
- –°—Ä–µ–¥–Ω–∏–π —á–µ–∫ –∏ –æ–±—â–∞—è –≤—ã—Ä—É—á–∫–∞
- –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### ‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≥–æ—Ä–æ–¥–∞–º
- –ó–≤–æ–Ω–∫–∏ –∏ –∑–∞–∫–∞–∑—ã –ø–æ –∫–∞–∂–¥–æ–º—É –≥–æ—Ä–æ–¥—É
- –í—ã—Ä—É—á–∫–∞ –∏ —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –∏ % –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–∫–∞–∑–æ–≤

### ‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –†–ö (—Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π)
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–π –†–ö
- ROI (–≤–æ–∑–≤—Ä–∞—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π)
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –∑–≤–æ–Ω–∫–æ–≤ –≤ –∑–∞–∫–∞–∑—ã
- –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ –ø–æ –∫–∞–∂–¥–æ–π –∫–∞–º–ø–∞–Ω–∏–∏

### ‚úÖ –î–Ω–µ–≤–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞
- –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤
- –î–∏–Ω–∞–º–∏–∫–∞ –≤—ã—Ä—É—á–∫–∏
- –¢—Ä–µ–Ω–¥—ã –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–∫–∞–∑–æ–≤

### ‚úÖ Dashboard Data
- –°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –ø–µ—Ä–∏–æ–¥ (–¥–µ–Ω—å/–Ω–µ–¥–µ–ª—è/–º–µ—Å—è—Ü)
- –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
- –ê–∫—Ç–∏–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
- –ó–∞–∫–∞–∑—ã –≤ —Ä–∞–±–æ—Ç–µ

### ‚úÖ Performance Metrics
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–∫–∞–∑–∞
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä–∞
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –≤–æ—Ä–æ–Ω–∫–∏
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (–ø—Ä–∏–±—ã–ª—å, —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å)

---

## üöÄ –õ–æ–∫–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd api-services/reports-service
npm install
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ `.env` —Ñ–∞–π–ª:

```env
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/callcentre_crm

# JWT
JWT_SECRET=your-jwt-secret-key

# Server
PORT=5007
CORS_ORIGIN=http://localhost:3000
```

### 3. Prisma –º–∏–≥—Ä–∞—Ü–∏—è

```bash
npx prisma generate
npx prisma db push
```

### 4. –ó–∞–ø—É—Å–∫

```bash
npm run start:dev
```

---

## üê≥ Docker Deployment

### 1. –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞

```bash
docker build -t your-registry/reports-service:latest .
```

### 2. –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

```bash
docker run -d \
  --name reports-service \
  -p 5007:5007 \
  -e DATABASE_URL="postgresql://user:pass@postgres:5432/db" \
  -e JWT_SECRET="your-secret" \
  your-registry/reports-service:latest
```

---

## ‚ò∏Ô∏è Kubernetes Deployment

### 1. Secrets

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: reports-service-secrets
  namespace: crm
type: Opaque
stringData:
  DATABASE_URL: "postgresql://user:pass@postgres:5432/db"
  JWT_SECRET: "your-jwt-secret"
```

### 2. Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reports-service
  namespace: crm
spec:
  replicas: 2
  selector:
    matchLabels:
      app: reports-service
  template:
    metadata:
      labels:
        app: reports-service
    spec:
      containers:
      - name: reports-service
        image: your-registry/reports-service:latest
        ports:
        - containerPort: 5007
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: reports-service-secrets
              key: DATABASE_URL
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: reports-service-secrets
              key: JWT_SECRET
        - name: PORT
          value: "5007"
        - name: CORS_ORIGIN
          value: "https://test-shem.ru"
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /api/health
            port: 5007
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/health
            port: 5007
          initialDelaySeconds: 10
          periodSeconds: 5
```

### 3. Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: reports-service
  namespace: crm
spec:
  selector:
    app: reports-service
  ports:
  - protocol: TCP
    port: 5007
    targetPort: 5007
```

---

## üìä API Examples

### 1. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤

```bash
# –í—Å–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –∑–∞ –º–µ—Å—è—Ü
curl -H "Authorization: Bearer <token>" \
  "http://localhost:5007/api/v1/analytics/operators?startDate=2024-10-01&endDate=2024-10-31"

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä
curl -H "Authorization: Bearer <token>" \
  "http://localhost:5007/api/v1/analytics/operators?operatorId=1"
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": [
    {
      "operatorId": 1,
      "operatorName": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
      "city": "–ú–æ—Å–∫–≤–∞",
      "status": "—Ä–∞–±–æ—Ç–∞–µ—Ç",
      "calls": {
        "total": 150,
        "answered": 120,
        "missed": 30,
        "avgDuration": 180,
        "answerRate": 80.0
      },
      "orders": {
        "total": 45,
        "completed": 30,
        "conversionRate": 37.5,
        "totalRevenue": 450000,
        "avgRevenue": 15000
      }
    }
  ]
}
```

### 2. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≥–æ—Ä–æ–¥–∞–º

```bash
curl -H "Authorization: Bearer <token>" \
  "http://localhost:5007/api/v1/analytics/cities?startDate=2024-10-01&endDate=2024-10-31"
```

### 3. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –†–ö

```bash
curl -H "Authorization: Bearer <token>" \
  "http://localhost:5007/api/v1/analytics/campaigns"
```

### 4. –î–Ω–µ–≤–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞

```bash
curl -H "Authorization: Bearer <token>" \
  "http://localhost:5007/api/v1/analytics/daily?city=–ú–æ—Å–∫–≤–∞"
```

### 5. Dashboard –¥–∞–Ω–Ω—ã–µ

```bash
# –ó–∞ —Å–µ–≥–æ–¥–Ω—è
curl -H "Authorization: Bearer <token>" \
  "http://localhost:5007/api/v1/analytics/dashboard?period=today"

# –ó–∞ –Ω–µ–¥–µ–ª—é
curl -H "Authorization: Bearer <token>" \
  "http://localhost:5007/api/v1/analytics/dashboard?period=week"
```

### 6. Performance Metrics

```bash
curl -H "Authorization: Bearer <token>" \
  "http://localhost:5007/api/v1/analytics/performance?startDate=2024-10-01&endDate=2024-10-31"
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Health Check

```bash
curl http://localhost:5007/api/health
```

### Logs

```bash
# Docker
docker logs -f reports-service

# Kubernetes
kubectl logs -f deployment/reports-service -n crm
```

---

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Frontend

### React/Next.js Example

```typescript
// services/analytics.ts
export const analyticsService = {
  async getOperatorStats(params) {
    const response = await fetch(
      `/api/v1/analytics/operators?${new URLSearchParams(params)}`,
      {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      }
    );
    return response.json();
  },

  async getDashboard(period = 'today') {
    const response = await fetch(
      `/api/v1/analytics/dashboard?period=${period}`,
      {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      }
    );
    return response.json();
  },
};

// components/Dashboard.tsx
function Dashboard() {
  const [dashboardData, setDashboardData] = useState(null);

  useEffect(() => {
    analyticsService.getDashboard('today').then(setDashboardData);
  }, []);

  return (
    <div>
      <h1>Dashboard</h1>
      {dashboardData && (
        <>
          <div>–ó–∞–∫–∞–∑–æ–≤: {dashboardData.data.orders.total}</div>
          <div>–í—ã—Ä—É—á–∫–∞: {dashboardData.data.revenue.total}</div>
          <div>–ö–æ–Ω–≤–µ—Ä—Å–∏—è: {dashboardData.data.performance.conversionRate}%</div>
        </>
      )}
    </div>
  );
}
```

---

## üêõ Troubleshooting

### –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–ø—Ä–æ—Å—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –¥–æ–ª–≥–æ

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- –°–æ–∑–¥–∞–π—Ç–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX IF NOT EXISTS idx_orders_create_date ON orders(create_date);
CREATE INDEX IF NOT EXISTS idx_orders_city_status ON orders(city, status_order);
CREATE INDEX IF NOT EXISTS idx_orders_rk ON orders(rk);
CREATE INDEX IF NOT EXISTS idx_calls_date_create ON calls(date_create);
CREATE INDEX IF NOT EXISTS idx_calls_operator_id ON calls(operator_id);
```

### –ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ–∂–∏–¥–∞–Ω–∏—è–º–∏

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é –≤ –ë–î
psql -U user -d callcentre_crm -c "SELECT COUNT(*) FROM orders WHERE create_date >= '2024-10-01';"

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤
psql -U user -d callcentre_crm -c "SELECT status_order, COUNT(*) FROM orders GROUP BY status_order;"
```

---

## üìù Performance Optimization

### Database Indexes

```sql
-- –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_orders_create_date 
ON orders(create_date);

CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_orders_city_create 
ON orders(city, create_date);

CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_orders_rk_create 
ON orders(rk, create_date);

CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_orders_operator_create 
ON orders(operator_name_id, create_date);

CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_calls_operator_date 
ON calls(operator_id, date_create);

CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_calls_city_date 
ON calls(city, date_create);
```

### Caching (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–î–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å Redis-–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ:

```typescript
// analytics.service.ts
import { CACHE_MANAGER, Inject } from '@nestjs/common';
import { Cache } from 'cache-manager';

async getDashboardData(period: string) {
  const cacheKey = `dashboard:${period}`;
  const cached = await this.cacheManager.get(cacheKey);
  
  if (cached) {
    return cached;
  }

  const data = await this.computeDashboardData(period);
  await this.cacheManager.set(cacheKey, data, { ttl: 300 }); // 5 min
  
  return data;
}
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

```bash
# 1. Health check
curl http://localhost:5007/api/health

# 2. –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
curl -H "Authorization: Bearer <token>" \
  http://localhost:5007/api/v1/analytics/operators

# 3. –ü–æ–ª—É—á–∏—Ç—å dashboard
curl -H "Authorization: Bearer <token>" \
  http://localhost:5007/api/v1/analytics/dashboard?period=today

# 4. Swagger UI
open http://localhost:5007/api
```

---

## üîÑ CI/CD

–°–º. `.github/workflows/docker-build.yml`

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [NestJS Documentation](https://docs.nestjs.com/)
- [Prisma Documentation](https://www.prisma.io/docs/)
- [ExcelJS Documentation](https://github.com/exceljs/exceljs)

